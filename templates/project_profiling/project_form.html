{% extends "base.html" %}
{% load widget_tweaks %}
{% load static %}

{% block content %}
<div class="max-w-5xl mx-auto p-6 bg-white rounded-xl shadow-md">
    <h1 class="text-3xl font-bold mb-6 text-gray-800 text-center">
        {% if project_type == 'GC' %}
            Create General Contractor Project
        {% elif project_type == 'DC' %}
            Create Direct Client Project
        {% else %}
            Create New Project
        {% endif %}
    </h1>

    <form method="post" class="grid grid-cols-1 md:grid-cols-2 gap-6" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Project Source -->
        <div class="col-span-2">
            <label for="id_project_source" class="block text-gray-700 mb-1">Project Source</label>
            {{ form.project_source }}
            {% if form.project_source.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.project_source.errors.0 }}</p>
            {% endif %}
        </div>

        <!-- Project Identification -->
        <div>
            <label for="id_project_code" class="block text-gray-700">Project Code</label>
            {{ form.project_code|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
            {% if form.project_code.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.project_code.errors.0 }}</p>
        {% endif %}
        </div>
        <div>
            <label for="id_project_name" class="block text-gray-700">Project Name</label>
            {{ form.project_name|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
            {% if form.project_name.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.project_name.errors.0 }}</p>
            {% endif %}
        </div>
        <div>
            <label for="id_project_type" class="block text-gray-700">Project Type</label>
            {{ form.project_type|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
            {% if form.project_type.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.project_type.errors.0 }}</p>
            {% endif %}
        </div>
        <div>
            <label for="id_project_category" class="block text-gray-700">Project Category</label>
            {{ form.project_category|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
            {% if form.project_category.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.project_category.errors.0 }}</p>
            {% endif %}
        </div>

        <div class="col-span-2">
            <label for="id_description" class="block text-gray-700">Description</label>
            {{ form.description|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
            {% if form.description.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.description.errors.0 }}</p>
            {% endif %}
        </div>

        <!-- DC Client Fields -->
        {% if project_type == 'DC' %}
        <div>
            <label for="id_client_name" class="block text-gray-700">Client Name</label>
            {{ form.client_name|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
            {% if form.client_name.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.client_name.errors.0 }}</p>
            {% endif %}
        </div>
        <div>
            <label for="id_client_address" class="block text-gray-700">Client Address</label>
            {{ form.client_address|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
            {% if form.client_address.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.client_address.errors.0 }}</p>
            {% endif %}
        </div>
        <div>
            <label for="id_client_contact_person" class="block text-gray-700">Client Contact Person</label>
            {{ form.client_contact_person|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
            {% if form.client_contact_person.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.client_contact_person.errors.0 }}</p>
            {% endif %}
        </div>
        <div>
            <label for="id_client_contact_number" class="block text-gray-700">Client Contact Number</label>
            {{ form.client_contact_number|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
            {% if form.client_contact_number.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.client_contact_number.errors.0 }}</p>
            {% endif %}
        </div>
        <div class="col-span-2">
            <label for="id_client_contact_email" class="block text-gray-700">Client Contact Email</label>
            {{ form.client_contact_email|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
            {% if form.client_contact_email.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.client_contact_email.errors.0 }}</p>
            {% endif %}
        </div>
        {% endif %}

        <!-- GC Fields -->
        {% if project_type == 'GC' %}
        <div>
            <label for="id_gc_company_name" class="block text-gray-700">GC Company Name</label>
            {{ form.gc_company_name|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
            {% if form.gc_company_name.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.gc_company_name.errors.0 }}</p>
            {% endif %}
        </div>
        <div>
            <label for="id_gc_license_number" class="block text-gray-700">GC License Number</label>
            {{ form.gc_license_number|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
            {% if form.gc_license_number.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.gc_license_number.errors.0 }}</p>
            {% endif %}
        </div>
        <div>
            <label for="id_gc_contact_person" class="block text-gray-700">GC Contact Person</label>
            {{ form.gc_contact_person|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
            {% if form.gc_contact_person.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.gc_contact_person.errors.0 }}</p>
            {% endif %}
        </div>
        <div>
            <label for="id_gc_contact_number" class="block text-gray-700">GC Contact Number</label>
            {{ form.gc_contact_number|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
            {% if form.gc_contact_number.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.gc_contact_number.errors.0 }}</p>
            {% endif %}
        </div>
        <div class="col-span-2">
            <label for="id_gc_contact_email" class="block text-gray-700">GC Contact Email</label>
            {{ form.gc_contact_email|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
            {% if form.gc_contact_email.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.gc_contact_email.errors.0 }}</p>
            {% endif %}
        </div>
        {% endif %}

        <!-- Location -->
        <div>
            <label for="id_location" class="block text-gray-700">Location</label>
            {{ form.location|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
            {% if form.location.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.location.errors.0 }}</p>
            {% endif %}
        </div>
        <div>
            <label for="id_city_province" class="block text-gray-700">City / Province</label>
            {{ form.city_province|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
            {% if form.city_province.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.city_province.errors.0 }}</p>
            {% endif %}
        </div>
        <div class="col-span-2">
            <label for="id_gps_coordinates" class="block text-gray-700">GPS Coordinates</label>
            {{ form.gps_coordinates|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
            {% if form.gps_coordinates.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.gps_coordinates.errors.0 }}</p>
            {% endif %}
        </div>

        <!-- Timeline -->
        <div>
            <label for="id_start_date" class="block text-gray-700">Start Date</label>
            {{ form.start_date|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
            {% if form.start_date.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.start_date.errors.0 }}</p>
            {% endif %}
        </div>
        <div>
            <label for="id_target_completion_date" class="block text-gray-700">Target Completion Date</label>
            {{ form.target_completion_date|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
            {% if form.target_completion_date.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.target_completion_date.errors.0 }}</p>
            {% endif %}
        </div>

        <!-- Personnel -->
        <div id="pm_container" class="relative col-span-2">
            <label for="project_manager_input" class="block text-gray-700 mb-1">Project Manager</label>
            <input type="text" id="project_manager_input" class="w-full border border-gray-300 rounded-md px-3 py-2"
                placeholder="Type or select a project manager" autocomplete="off"
                value="{{ form.instance.project_manager.full_name|default:'' }}">
            <input type="hidden" id="project_manager_id" name="project_manager"
                value="{{ form.instance.project_manager.id|default:'' }}">
            <ul id="pm_suggestions"
                class="absolute w-full bg-white border border-gray-300 rounded-md mt-1 hidden max-h-48 overflow-y-auto z-50"></ul>
            <div id="assigned_pm_display" class="mt-3 text-gray-800 font-medium">
                {% if form.instance.project_manager %}
                    Assigned to: {{ form.instance.project_manager.full_name }}
                {% else %}
                    No Project Manager Assigned
                {% endif %}
                {% if form.project_manager.errors %}
                <p class="text-red-600 text-sm mt-1">{{ form.project_manager.errors.0 }}</p>
                {% endif %}
            </div>
        </div>

        <div>
            <label for="id_site_engineer" class="block text-gray-700">Site Engineer</label>
            {{ form.site_engineer|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
            {% if form.site_engineer.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.site_engineer.errors.0 }}</p>
            {% endif %}
        </div>

       <!-- Financials -->
<div>
    <label for="id_estimated_cost" class="block text-gray-700">Estimated Cost</label>
    {{ form.estimated_cost|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
    {% if form.estimate_cost.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.estimate_cost.errors.0 }}</p>
            {% endif %}
</div>

<div class="col-span-2">
    <label for="id_payment_terms" class="block text-gray-700">Payment Terms</label>
    {{ form.payment_terms|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
    {% if form.payment_terms.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.payment_terms.errors.0 }}</p>
            {% endif %}
</div>

        <div>
    <label for="id_subcontractors" class="block text-gray-700">Subcontractors</label>
    {{ form.subcontractors|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
    {% if form.subcontractors.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.subcontractors.errors.0 }}</p>
            {% endif %}
</div>
<div>
            <label for="id_status" class="block text-gray-700">Status</label>
            {{ form.status|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
            {% if form.status.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.status.errors.0 }}</p>
            {% endif %}
        </div>
<div class="col-span-2">
    <label for="id_contract_agreement" class="block text-gray-700">Contract Agreement</label>
    {{ form.contract_agreement|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
</div>
<div class="col-span-2">
    <label for="id_permits_licenses" class="block text-gray-700">Permits & Licenses</label>
    {{ form.permits_licenses|add_class:"w-full border border-gray-300 rounded-md px-3 py-2" }}
</div>
<div class="col-span-2 text-center pt-4">
    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
        Save Project
    </button>
</div>
    </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const input = document.getElementById("project_manager_input");
        const hiddenField = document.getElementById("project_manager_id");
        const suggestionsBox = document.getElementById("pm_suggestions");
        const assignedDisplay = document.getElementById("assigned_pm_display");

        async function fetchProjectManagers(query) {
            const response = await fetch(`/projects/search/project-managers/?q=${encodeURIComponent(query)}`);
            if (!response.ok) return [];
            return await response.json();
        }

        input.addEventListener("input", async () => {
            const query = input.value.trim();
            suggestionsBox.innerHTML = "";

            if (!query) {
                suggestionsBox.classList.add("hidden");
                return;
            }

            const results = await fetchProjectManagers(query);
            if (results.length === 0) {
                suggestionsBox.classList.add("hidden");
                return;
            }

            results.forEach(pm => {
                const li = document.createElement("li");
                li.className = "px-3 py-2 cursor-pointer hover:bg-gray-100";
                li.textContent = `${pm.username} / ${pm.full_name} / ${pm.email}`;
                li.addEventListener("click", () => {
                    input.value = pm.full_name;
                    hiddenField.value = pm.id;
                    assignedDisplay.textContent = `Assigned to: ${pm.full_name} (${pm.email})`;
                    suggestionsBox.classList.add("hidden");
                });
                suggestionsBox.appendChild(li);
            });

            suggestionsBox.classList.remove("hidden");
        });

        document.addEventListener("click", (e) => {
            if (!document.getElementById("pm_container").contains(e.target)) {
                suggestionsBox.classList.add("hidden");
            }
        });
    });
</script>

<script src="{% static 'js/projects.js' %}"></script>
{% endblock %}
