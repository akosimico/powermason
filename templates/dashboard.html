{% extends "base.html" %}
{% load static %}
{% block content %}
{% load humanize %}
{% load role_tags %}

       {% if user.is_superuser or user|has_role:"OM" or user|has_role:"EG" %}
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
  <div class="bg-white p-6 rounded-2xl shadow-md text-center filter-card cursor-pointer" data-status="PL">
    <h3 class="text-lg font-semibold">Planned</h3>
    <p class="text-3xl font-bold text-gray-700">{{ status_counts.planned }}</p>
  </div>
  <div class="bg-white p-6 rounded-2xl shadow-md text-center filter-card cursor-pointer" data-status="OG">
    <h3 class="text-lg font-semibold">Ongoing</h3>
    <p class="text-3xl font-bold text-blue-600">{{ status_counts.ongoing }}</p>
  </div>
  <div class="bg-white p-6 rounded-2xl shadow-md text-center filter-card cursor-pointer" data-status="CP">
    <h3 class="text-lg font-semibold">Completed</h3>
    <p class="text-3xl font-bold text-green-600">{{ status_counts.completed }}</p>
  </div>
  <div class="bg-white p-6 rounded-2xl shadow-md text-center filter-card cursor-pointer" data-status="CN">
    <h3 class="text-lg font-semibold">Cancelled</h3>
    <p class="text-3xl font-bold text-red-600">{{ status_counts.cancelled }}</p>
  </div>
</div>
{% endif %}


<!-- ✅ Charts & Calendar -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
  <!-- Progress Chart -->
  <div class="bg-white p-6 rounded-2xl shadow-md h-[500px] lg:h-[600px] flex flex-col">
    <h2 class="text-xl font-semibold mb-4">Project Progress: Actual vs Planned</h2>
    <div class="flex-1 min-h-0">
      <canvas id="progressChart" class="w-full h-full"></canvas>
    </div>
  </div>

  <!-- Task Calendar -->
  <div class="bg-white p-6 rounded-2xl shadow-md h-[500px] lg:h-[600px] flex flex-col">
    <h2 class="text-xl font-semibold mb-4">Task Calendar</h2>
    <div id="taskCalendar" class="flex-1 min-h-0"></div>
  </div>
</div>

<!-- ✅ Task Details Modal -->
<div id="taskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-lg p-6 w-[400px]">
    <h2 id="modalTitle" class="text-xl font-semibold mb-4">Task Details</h2>
    <div id="modalBody" class="space-y-2 text-gray-700"></div>
    <div class="mt-6 text-right">
      <button onclick="document.getElementById('taskModal').classList.add('hidden')" 
              class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
        Close
      </button>
    </div>
  </div>
</div>

{% if user.is_superuser or user|has_role:"OM" or user|has_role:"EG" %}
<!-- Budget Summary Chart -->
<h3 class="text-lg font-semibold text-gray-700 mt-4 mb-4 text-center">Budget Summary</h3>
<div class="overflow-x-auto h-96 w-full">
    <canvas id="budgetChart" style="width:100%; height:100%;"></canvas>
</div>
{% endif %}


</div>

{% endblock %}

{% block extra_scripts %}

<script type="application/json" id="projects-data">{{ projects_json|safe }}</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
<script src="{% static 'js/dashboard_project.js' %}"></script>
{% endblock %}
