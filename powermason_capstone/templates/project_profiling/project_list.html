{% extends "base.html" %}
{% load static %}
{% load role_tags %}

{% block content %}
<div class="max-w-7xl mx-auto mt-8 px-4 sm:px-6 lg:px-8">

    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Project List</h1>

        <div class="mt-4 sm:mt-0 flex gap-2">
            {% if user.is_superuser or user|has_role:"OM" or user|has_role:"EG" %}
            <!-- Add Project Dropdown -->
            <div class="relative inline-block text-left">
                <button type="button"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md font-medium transition flex items-center justify-between w-full"
                    id="addProjectButton">
                    + Add Project
                    <svg class="ml-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>

                <!-- Dropdown menu -->
                <div id="addProjectDropdown"
                    class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden">
                    <div class="py-1">
                        <a href="{% url 'project_create' token=dashboard_token role=role project_type='GC' %}"
                            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900">
                            General Contractor
                        </a>
                        <a href="{% url 'project_create' token=dashboard_token role=role project_type='DC' %}"
                            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900">
                            Direct Client
                        </a>
                    </div>
                </div>

            </div>


            {% endif %}
            <!-- Search Input -->
            <input type="text" id="projectSearchInput" placeholder="Search projects..."
                class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
        </div>
    </div>



    <!-- Project Table -->
    <div class="overflow-x-auto border border-gray-200 rounded-lg shadow-sm">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Manager
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start
                        Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Target
                        Completion</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Budget
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status
                    </th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions
                    </th>
                </tr>
            </thead>
            <tbody id="projectTableBody" class="bg-white divide-y divide-gray-200">
                {% for project in projects %}
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-3 text-gray-900 font-medium">{{ project.project_code }}</td>
                    <td class="px-6 py-3 text-gray-900">{{ project.project_name }}</td>
                    <td class="px-6 py-3 text-gray-700">{{ project.project_type }}</td>
                    <td class="px-6 py-3 text-gray-700">{{ project.project_category }}</td>
                    <td class="px-6 py-3 text-gray-700">
                        {% if project.project_manager %}
                        {{ project.project_manager.full_name }}
                        {% else %}
                        <span class="text-gray-400 italic">Unassigned</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-3 text-gray-700">{{ project.start_date }}</td>
                    <td class="px-6 py-3 text-gray-700">{{ project.target_completion_date }}</td>
                    <td class="px-6 py-3 text-gray-700">₱{{ project.approved_budget|floatformat:2 }}</td>
                    <td class="px-6 py-3">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                        {% if project.status == 'Completed' %} bg-green-100 text-green-800 
                        {% elif project.status == 'Ongoing' %} bg-blue-100 text-blue-800 
                        {% else %} bg-yellow-100 text-yellow-800 {% endif %}">
                            {{ project.status }}
                        </span>
                    <td class="px-6 py-3 text-center">

                        {% if user.is_superuser or user|has_role:"OM" or user|has_role:"EG" %}
                        <!-- Edit -->
                        <a href="{% url 'project_edit' dashboard_token role project.project_type project.id %}"
                            class="text-blue-500 hover:text-blue-600 font-medium mr-2">Edit</a>

                        <!-- Delete (X instead of text) -->
                        <a href="{% url 'project_delete' dashboard_token role project.project_type project.id %}"
                            class="text-red-500 hover:text-red-600 font-bold mr-2" title="Delete">X</a>
                        
                        <!-- Schedule (new link to task list) -->
                      <a href="{% url 'task_list' project.id dashboard_token role %}" class="text-green-500 hover:text-green-600 font-medium" title="View Schedule"></a>
                      
                        
                      




<a href="{% url 'task_list' project.id dashboard_token role %}" 
   class="text-green-500 hover:text-green-600 font-medium inline-flex items-center"
   title="View Schedule" aria-label="View Schedule">
  <svg xmlns="http://www.w3.org/2000/svg" 
       viewBox="0 0 24 24" fill="none" 
       stroke="currentColor" stroke-width="1.5" 
       stroke-linecap="round" stroke-linejoin="round"
       class="h-5 w-5">
    <!-- top rings -->
    <path d="M8 2.75v3.5M16 2.75v3.5" />
    <!-- outer frame -->
    <rect x="3.25" y="4.75" width="17.5" height="16" rx="2.25" />
    <!-- month separator -->
    <path d="M3.25 9.5h17.5" />
    <!-- optional small date dots (remove if you want cleaner look) -->
    <path d="M7.5 13h.01M11.5 13h.01M15.5 13h.01M7.5 16.5h.01M11.5 16.5h.01M15.5 16.5h.01" />
  </svg>
</a>

                       {% elif user|has_role:"PM" %}
<div class="flex space-x-2">
    <!-- View Button (Gray, View Only) -->
    <a href="{% url 'project_view' dashboard_token role project.project_type project.id %}"
       class="inline-block px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium 
              rounded-lg shadow-sm hover:bg-gray-300 focus:outline-none 
              focus:ring-2 focus:ring-gray-400 focus:ring-offset-1 
              transition duration-200 ease-in-out"
       title="View only – you cannot edit this project">
        View
    </a>


    <!-- Submit Report Button (Primary Blue, Small) -->
<a href="{% url 'task_list' project.id dashboard_token role %}" 
   class="inline-block px-3 py-1.5 bg-blue-600 text-white text-xs font-medium 
          rounded-md shadow hover:bg-blue-700 focus:outline-none 
          focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 
          transition duration-200 ease-in-out">
    View Tasks
</a>

</div>
{% endif %}

                    </td>

                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-center py-4 text-gray-500">No projects found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/projects.js' %}"></script>
{% endblock %}